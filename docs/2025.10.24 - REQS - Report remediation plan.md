# Remediation Plan – mdkloc Code Review (2025-10-24)

## Objective
Address the issues identified in `docs/2025.10.24 - CR - Repository review.md` by sequencing engineering and documentation work that restores correctness, aligns messaging, and removes unused artifacts.

## Stage 0 – Preparation
- **Scope confirmation**: Share this plan with maintainers, confirm unaffected areas.
- **Branch strategy**: Work on feature branches per stage to simplify review.
- **Baseline verification**: Capture current CLI output on a representative repository for regression comparison.

## Stage 1 – Correct root-level ignore handling (Important)
- **Tasks**
  - Update `scan_directory_impl` to apply the hard-coded ignore list only when `current_depth > 0`, or otherwise ensure the explicit root path is honored.
  - Extend unit/integration coverage to include a run that targets a directory named `target` at the root and asserts results are returned.
- **Deliverables**
  - Code changes in `src/main.rs`.
  - New or updated tests in `tests/cli_smoke.rs` (or dedicated unit tests).
- **Acceptance Criteria**
  - Running `mdkloc target` (with a temporary fixture) yields language totals instead of an empty report.
  - Existing failure-injection tests continue to pass.

## Stage 2 – Fix shell dotfile parsing (Important)
- **Tasks**
  - Ensure `count_lines_with_stats` routes recognized shell dotfiles (`.bashrc`, `.profile`, etc.) to `count_shell_lines`.
  - Add unit tests covering a shell dotfile with comments to verify classification.
- **Deliverables**
  - Adjusted dispatch logic in `src/main.rs`.
  - New unit tests (e.g., `test_count_lines_with_stats_shell_dotfiles`).
- **Acceptance Criteria**
  - Comments inside shell dotfiles are counted as comment lines, not code.
  - Regression suite passes.

## Stage 3 – Documentation alignment (Minor)
- **Tasks**
  - Update README version reference to 2.3.0 (or current crate version).
  - Remove or rewrite bullets that claim parallel execution or Unicode normalization unless those features land.
  - Cross-check `readme.md` “What’s New” section for accuracy post-change.
- **Deliverables**
  - Revised `readme.md`.
- **Acceptance Criteria**
  - README accurately reflects existing capabilities and version.
  - No dangling references to removed features.

## Stage 4 – Dependency cleanup (Minor)
- **Tasks**
  - Drop `unicode-normalization` from `Cargo.toml` if no longer required.
  - Update `Cargo.lock` via `cargo update` or manual edit after dependency removal.
- **Deliverables**
  - Updated `Cargo.toml` and `Cargo.lock`.
- **Acceptance Criteria**
  - `cargo check` and `cargo build` succeed without the dependency.
  - README no longer references Unicode normalization unless reintroduced.

## Stage 5 – Validation & Release
- **Tasks**
  - Run `cargo fmt`, `cargo clippy -- -D warnings`, and `cargo test` (re-run once network access or vendored crates are available).
  - Execute integration tests targeting the Stage 1 & 2 scenarios.
  - Capture before/after CLI output for release notes.
- **Deliverables**
  - Test logs stored in docs/journal as appropriate.
  - Optional: draft changelog entry for the next release.
- **Acceptance Criteria**
  - All automated checks pass locally.
  - Manual spot checks confirm expected behavior in the CLI output.

## Stage 6 – Follow-up
- **Tasks**
  - Evaluate whether large `src/main.rs` should be modularized (deferred item).
  - Consider reintroducing parallelism/Unicode normalization only with proper implementation and documentation.
  - Solicit peer review and merge once approvals obtained.
- **Deliverables**
  - Issue tickets or backlog entries for deferred work.

