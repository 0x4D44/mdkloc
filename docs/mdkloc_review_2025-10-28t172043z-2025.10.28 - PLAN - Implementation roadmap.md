# Multi-Stage Implementation Plan – mdkloc (2025-10-28)

## Source Reviews
- `docs/mdkloc_review_2025-10-28t172043z-2025.10.28 - CR - Full repository review.md` (2025-10-28) – most recent code review outlining correctness gaps (symlink handling, max-entry guard), structural risks, and UX/issues (color handling, unused dependency).

## Stage 1 – Correctness Hotfixes (Week 1)
**Objectives**
- Count symlinked files exactly once without introducing traversal loops.
- Enforce the configured `max_entries` limit regardless of filters or directory depth.

**Activities**
- Update traversal logic to resolve metadata for symlinked files (`DirEntry::metadata` or `fs::metadata`) while still skipping symlinked directories.
- Add guardrails to prevent duplicate counting of symlink targets (track visited inode/path pairs where platforms expose them).
- Increment `entries_count` before file-spec filters execute and include directories in the tally; exit early with a descriptive error once the limit trips.
- Capture failure modes (e.g., broken symlinks, metadata errors, limit exceeded) with precise error messages.

**Deliverables / Exit Criteria**
- Unit or integration tests covering: symlinked file counted once, symlink loops rejected, `max_entries` terminating scans even when filters exclude most files, and directory-heavy trees tripping the limit.
- Updated developer docs or inline comments summarizing the new traversal rules.

## Stage 2 – Regression Harness & Tooling (Week 2)
**Objectives**
- Lock in the Stage 1 fixes across platforms and prevent regressions.

**Activities**
- Add integration fixtures under `tests/` containing symlinked files and deep directory fan-out (skip or gate Windows tests unless symlink privilege available).
- Extend existing CLI smoke tests to assert that exceeding `--max-entries` returns a non-zero exit code and an actionable message.
- Wire the new tests into CI (Linux primary; document manual steps for macOS/Windows verification).
- Add targeted benchmarks if traversal hot paths change measurably.

**Deliverables / Exit Criteria**
- Green CI run with the expanded test matrix.
- Documented manual verification steps for platforms where automated symlink tests are gated.

## Stage 3 – UX & Dependency Cleanup (Week 3)
**Objectives**
- Respect terminal capabilities and simplify dependency surface.

**Activities**
- Switch Clap color configuration to `ColorChoice::Auto`, honoring `NO_COLOR`, `CLICOLOR(_FORCE)`, and a new `--color` override.
- Add regression tests that redirect output to a file/pipe ensuring no ANSI escapes appear when colors are disabled.
- Remove the unused `unicode-normalization` dependency from `Cargo.toml` and `Cargo.lock`; run `cargo update -p unicode-normalization --precise ...` if needed to clean lockfile.
- Audit documentation (`readme.md`, --help output) to describe the new color behaviour and flag.

**Deliverables / Exit Criteria**
- CLI help text and README updated with color-handling guidance.
- Clippy/lint passes confirm no unused imports or warnings after dependency removal.

## Stage 4 – Structural Refactor (Weeks 4–5)
**Objectives**
- Break down the 5k+ line `src/main.rs` into cohesive modules to improve maintainability.

**Activities**
- Introduce `src/lib.rs` housing reusable logic; keep `main.rs` focused on argument parsing and top-level orchestration.
- Carve modules for CLI (`cli.rs`), traversal/scanning (`scanner.rs`), language classification (`language/mod.rs` with submodules), reporting (`report.rs`), and metrics/types (`metrics.rs`).
- Move existing inline tests beside the code they validate; migrate broader scenarios to `tests/`.
- Ensure public interfaces remain stable (re-export as needed from `lib.rs`) and run rustfmt after each extraction.

**Deliverables / Exit Criteria**
- Code builds and tests pass with the new module layout.
- Contributor guide or README gains a short section describing the module boundaries.

## Stage 5 – Release Hardening (Week 6)
**Objectives**
- Validate readiness for release and capture lessons learned.

**Activities**
- Run `cargo fmt`, `cargo clippy -- -D warnings`, `cargo test`, and targeted `cargo run` smoke checks on representative repositories (with/without symlinks, large directories).
- Update CHANGELOG/Release notes summarizing functional fixes (symlink counting, entry limits, color toggles) and structure changes.
- Announce migration considerations for contributors (e.g., new module paths) and highlight new tests/fixtures for onboarding.

**Deliverables / Exit Criteria**
- Signed-off release checklist with toolchain commands and sample outputs.
- Internal communication or pull-request summary referencing this plan and the addressed review findings.

---

**Ongoing Considerations**
- Monitor performance impacts after Stage 1/Stage 4; profile if traversal costs grow.
- Coordinate cross-platform testing for symlinks (Windows developer mode instructions).
- Keep this plan updated if further code reviews surface new risks before completion.
