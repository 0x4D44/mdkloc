# Code Review – mdkloc (2025-10-28)

## Summary
- Line counting engine is feature-rich with broad language support and extensive fault-injection tests, yet several structural choices still undermine correctness guarantees when scanning real repositories.
- The CLI currently skips entire classes of files (notably symlinks) and the traversal limit can be bypassed when filters are applied, which risks inaccurate results or unexpectedly long scans.
- The implementation lives in a single 5k+ line source file; refactoring into focused modules would markedly improve readability, test isolation, and contributor onboarding.
- Tightening these issues requires modest code changes plus targeted regression tests (symlinked files, max-entry guard) to lock in the intended behaviour across platforms.

## Findings

### Important
- **Symlinked source files are silently ignored** – during directory traversal we only process entries when `file_type.is_file() && !file_type.is_symlink()`; `DirEntry::file_type()` reports symlinks distinctly, so symlinked files never reach `process_file`. Many repositories (e.g., mono-repos that share generated headers via symlinks) would under-report language totals. Fix by resolving symlink metadata for files (use `DirEntry::metadata()`/`fs::metadata` to follow the link) while still refusing to recurse into symlinked directories to avoid cycles or infinite loops. Add regression tests on platforms that support symlinks (Unix by default, Windows when developer mode is enabled) to prove symlinked files contribute to totals exactly once. (`src/main.rs:2131`)
- **`max_entries` safeguard counts only accepted files** – `entries_count` increments after the filespec check (`should_process_file`). When users filter (e.g. `--filespec *.rs`), the scan walks every directory entry even if millions do not match and the guard never trips. Directories are also excluded from the counter, so deep trees with many folders bypass the limit entirely. Move the increment before the filter, include directory entries in the tally, and bail out immediately when the limit is exceeded. Follow up with tests that populate large filtered trees to ensure the guard fires. (`src/main.rs:1961-1969`)
- **Monolithic main module hampers maintainability** – all CLI parsing, traversal, per-language classifiers, reporting, and tests coexist in one file exceeding 5,000 lines. This makes reviews and targeted changes expensive and raises merge-conflict risk. Split the crate into modules (e.g., `cli.rs`, `scanner.rs`, `language/{*.rs}`, `report.rs`, `metrics.rs`, `tests/`) so each concern stays focused and incremental changes become approachable. (`src/main.rs:1`)

### Minor
- **Unused dependency** – `unicode-normalization` is declared but never referenced, increasing compile time and dependency surface without benefit. Prune it or document the upcoming use. (`Cargo.toml:8`)
- **Always-on ANSI color** – the Clap definition pins `ColorChoice::Always`, so redirecting output to files or CI logs produces raw escape codes. Switching to `Auto` (and honoring `NO_COLOR`/`CLICOLOR`) would make the CLI friendlier in non-TTY contexts while still supporting explicit opt-in. (`src/main.rs:56`)

## Test Coverage Notes
- Unit tests exercise most failure-injection paths and language-specific counters. Integration smoke tests validate CLI success, filtering, and warnings. That breadth is a strong foundation.
- No tests currently exercise symlink handling or `max_entries` exhaustion, which likely would have surfaced the issues above. Adding regression coverage after implementing the fixes will help prevent recurrences.

## Positive Observations
- Failure-injection tags (`METADATA_FAIL_TAG`, etc.) and the associated tests provide excellent confidence that filesystem errors degrade gracefully.
- The reporting pipeline balances per-directory detail with global totals, and the normalization step avoids double-count drift across languages.
- CLI smoke tests cover a healthy spread of flag combinations, ensuring options like `--filespec`, `--ignore`, and `--max-depth` stay functional.
