# mdkloc Remediation Roadmap

**Run**: mdkloc review 2025-10-26T17:29:43Z  
**Date**: 2025-10-26  
**Source Report**: `docs/mdkloc_review_2025-10-26t172943z-2025.10.26 - CR - Full repository review.md`

## Stage 1 – Immediate Correctness Fixes (Week 1)
- **Goals**: Restore accurate counts for explicitly requested directories and common file types.
- **Tasks**:
  - Update `scan_directory_impl` to skip built-in ignores only after the first recursion depth; add integration coverage for `mdkloc path/target`. *(Owners: CLI traversal)*
  - Introduce a fallback language (e.g., “Other”) so unmapped extensions and extensionless names flow through `count_generic_lines`; add CLI regression for `.txt`/`.md` and unit tests around `process_file`. *(Owners: Line counting)*
  - Route shell dotfiles through `count_shell_lines` and backfill unit coverage mirroring existing shell parser tests. *(Owners: Line counting)*
- **Deliverables**: Passing `cargo test`, updated `tests/cli_smoke.rs`, new unit tests, changelog entry summarizing fixes.

## Stage 2 – Traversal Safety & Filtering (Week 2)
- **Goals**: Ensure traversal knobs (`--max-entries`, `--filespec`) provide deterministic bounds.
- **Tasks**:
  - Count and enforce directory entries prior to classification, or split into per-directory/per-file quotas; add integration tests that exceed the limit for both files and directories.
  - Teach traversal to leverage `--filespec` before descending (suffix heuristics and/or user-provided allowlists); document any fallback behavior when avoidance is impossible.
  - Cross-check performance on large fixtures (e.g., `tmp-review/fanout`, `tmp-review/manytxt`) to confirm early aborts.
- **Deliverables**: Updated traversal code, expanded CLI smoke tests, README note describing the refined semantics.

## Stage 3 – Documentation & Dependency Alignment (Week 3)
- **Goals**: Align outward-facing claims with shipped functionality.
- **Tasks**:
  - Update README version banners and remove promises about Unicode normalization/parallelism until implemented.
  - Drop the unused `unicode-normalization` dependency (and lockfile entry) or wire it into path handling if future work is scheduled.
  - Capture release notes highlighting the behavioral changes from Stages 1–2.
- **Deliverables**: Clean README, trimmed dependency list, release prep notes.

## Stage 4 – Architectural Decomposition (Weeks 4–6)
- **Goals**: Reduce the 9,116-line `src/main.rs` into cohesive modules to improve maintainability.
- **Tasks**:
  - Define a module layout (`cli`, `scanner`, `languages`, `report`, `metrics`, `faults`) and migrate code incrementally.
  - Relocate unit tests beside their modules or into `tests/` integration suites to keep the entry point lean.
  - Establish lint or CI guardrails to prevent future bloat (e.g., enforce module boundaries, track file length).
- **Deliverables**: New module tree, updated `mod` declarations, refreshed tests, architectural ADR summarizing the restructuring.

## Governance & Tracking
- Record progress in the project journal using the run token slug for all artefacts.
- Gate merges on `cargo fmt`, `cargo clippy -- -D warnings`, and the expanded test suite described above.
- Review this roadmap after Stage 2 to adjust timelines or scope based on effort discovered during traversal fixes.
