# Coverage Improvement Plan (2025-10-16)

## Baseline Coverage
- Ran `cargo llvm-cov --workspace --summary-only` on 2025-10-16.
- Reported metrics: regions 72.9%, lines 82.1%, functions 88.1%.
- Coverage holes concentrate entirely in `src/main.rs`.

### Zero-coverage entry points
- `main`: CLI banner, Clap parsing, directory aggregation, and summary output never exercised under tests.
- `PerformanceMetrics::print_progress` and `PerformanceMetrics::print_final_stats`: progress reporting/summary I/O not evaluated.
- `print_language_stats`: formatting layer only used by CLI.
- Clap-derived `Args::from_arg_matches_mut` closures: lack of CLI parsing tests leaves every generated closure uncovered.
- `scan_directory` sorting/aggregation closures (lines ~1830–2095) invoked only through `main`.

## Progress Update (2025-10-16, evening)
- Latest `cargo llvm-cov --workspace --summary-only` run on 2025-10-16 reports regions 77.67%, lines 94.19%, and functions 94.58%.
- Added regression tests for filespec inclusion/exclusion (`filespec_matches`, `should_process_file`) and for progress printer throttling/disabled paths.
- Broadened parser fixtures across Rust, Pascal, PHP, JavaScript/JSX, PowerShell, and IPLAN to hit trailing-code and nested-comment branches.

### Functions below 70% region coverage
| Function | Region Coverage | Notable uncovered scenarios |
| --- | --- | --- |
| `mdkloc::count_rust_lines` | 56.2% | Block comments that close mid-line with trailing code, attribute lines (`#[cfg]`), and mixed block + line comment sequences. |
| `mdkloc::count_php_lines` | 56.8% | Mixed `/* */` with trailing `//`/`#`, reopening multi-line comments, and code segments after comment terminators. |
| `mdkloc::count_iplan_lines` | 57.5% | Block comments followed by `!` inline annotations, and multi-line comment closures with residual code. |
| `mdkloc::count_c_style_lines` | 58.5% | Lines containing both `//` and `/*`, nested block comments, and continuation after inline `*/`. |
| `mdkloc::count_algol_lines` | 59.3% | `COMMENT` blocks without terminating `;`, `co ... co` comment form, and leading `#` comments. |
| `mdkloc::count_powershell_lines` | 60.4% | `<# #>` block comments with trailing code, nested block transitions, and interleaved `#` line comments. |
| `mdkloc::count_javascript_lines` | 62.5% | JSX `<!-- -->` state transitions, block comments with trailing statements, and inline `//` after block closures. |
| `mdkloc::count_pascal_lines` | 62.7% | `{}` vs `(* *)` block combinations and lines mixing block + line comment markers. |
| `mdkloc::count_python_lines` | 65.9% | Triple-quoted strings that open/close on one line, continued lines with `\\`, and inline comments following string terminators. |
| `mdkloc::count_lines_with_stats` | 70.4% | Special filename shortcuts (`Dockerfile*`, `Makefile` variants, `CMakeLists.txt`) and rare extensions not covered by tests. |
| `mdkloc::scan_directory_impl` | 73.0% | Error counting, `max_depth` exhaustion, and ignore patterns combined with recursion toggles. |

## Action Plan

1. **Exercise CLI surfaces (High priority)**
   - Extract a `run_cli(args: Args) -> io::Result<()>` helper or gate `main` logic behind a testable function to avoid env-dependent exits.
   - Add integration tests under `tests/cli_smoke.rs` invoking the binary via `Command::new(env!("CARGO_BIN_EXE_mdkloc"))` to capture stdout/stderr.
   - Cover: default scan of a temp tree, `--non-recursive`, `--ignore`, nonexistent path error, and confirmation that progress summary renders without panicking.
   - Validate numeric totals to indirectly execute `print_language_stats`, `PerformanceMetrics::print_final_stats`, and Clap parsing closures.

2. **Boost branch coverage for language counters (High priority)**
   - Build table-driven fixtures (e.g., inline arrays of `(language, source, expected_counts)`) to hit every branch in the low-coverage parsers listed above.
   - Add targeted tests per function:
     - Rust & C-style: lines combining code + comment markers, nested block comments, `#[attribute]` cases.
     - PHP / PowerShell / IPLAN: blocks with trailing code or additional comment markers, ensure `#` and `!` flows are exercised.
     - JavaScript: JSX comment open/close overlap and block comments with trailing `//`.
     - Pascal & Algol: alternate comment syntaxes (`{}`, `(* *)`, `co ... co`, `COMMENT` without semicolon) and blank-line preservation.
     - Python: triple quotes opening/closing on same line, escaped newline continuations, inline comments after docstrings.
   - Reuse helper writers in `tests` to keep fixtures concise and to avoid code duplication.

3. **Dispatcher & directory traversal coverage (Medium priority)**
   - Extend unit tests for `get_language_from_extension` to include dotfiles (`.bashrc`, `.zprofile`), multi-part extensions, and case-folded `Dockerfile.prod`.
   - Add regression tests for `count_lines_with_stats` ensuring each special-case filename delegates to the right counter and that unknown extensions default correctly.
   - Augment `scan_directory_impl` tests to cover: hitting `max_entries` cap, enforcing `max_depth` with nested directories, verifying `ignore` patterns skip matches, and confirming error accounting when files fail to read.

4. **Test progress reporting hooks (Medium priority)**
   - Inject a `Write` trait object or buffered sink into `PerformanceMetrics` so tests can assert on the progress messages without touching global stdout.
   - Unit-test throttling (`Duration::from_secs(1)`) and final summary formatting.

5. **Tooling follow-up (After new tests land)**
   - Add a CI `cargo llvm-cov --workspace --fail-under-lines 85 --fail-under-regions 80` guard once coverage improves.
   - Document the coverage workflow in `readme.md` so running `cargo llvm-cov` becomes part of the local checklist.

## Sequencing & Verification
- Implement items 1 and 2 first; they offer the largest coverage delta and unlock CLI smoke tests for future regressions.
- After each milestone, run `cargo fmt`, `cargo clippy -- -D warnings`, `cargo test`, and `cargo llvm-cov --workspace --summary-only` to verify gains.
- Track coverage deltas in `REVIEW.md` or a new `docs/coverage.md` as fixes land to keep future reviews grounded.
---

# Targeted Coverage Expansion Plan (2025-10-16)

Recent `cargo llvm-cov --workspace --json` output highlights the following low-coverage hotspots:

- `count_powershell_lines` (~62% of regions executed)
- `count_rust_lines` (~63% of regions executed)
- `count_pascal_lines` (~69% of regions executed)
- Dispatcher helpers (`count_php_lines`, `count_python_lines`, `count_hcl_lines`, `count_c_style_lines`) and the CLI progress printer, each sitting near 60–70% region coverage.

## Implementation Steps
1. **PowerShell Comment Matrix**
   - Build a table-driven test harness covering `<# #>` blocks that reopen on the same line, block-to-line comment transitions, and unterminated block sequences.
   - Ensure assertions capture both comment counts and the code paths where `progress_enabled` remains true.

2. **Rust & Pascal Mixed Comment Coverage**
   - Expand existing fixtures with nested block comments, attribute macros followed by comments, and `{}` vs. `(* *)` combinations that reopen mid-line.
   - Verify the Pascal nesting counters by asserting both comment depth markers and trailing code detection.

3. **Hash Comment Languages Sweep**
   - Generate shared fixtures for INI/JSON/YAML/TOML with combinations of `#`, `;`, inline comments after values, and blank lines.
   - Confirm `count_hash_comment_lines` increments both code and comment counts in mixed scenarios.

4. **C-style Dispatcher Regression Table**
   - Consolidate proto/Scala/JavaScript mixed-comment tests into a reusable table that feeds through `count_c_style_lines`.
   - Add cases with overlapping `//` and `/* */` segments to exercise branch logic that currently reports as uncovered.

5. **CLI Progress Output Validation**
   - Introduce a test that forces `print_progress` to run multiple cycles (e.g., simulate 10 updates) and assert the buffered writer contains rate hints in every pass.
   - Cover the error path by invoking `run_cli_with_metrics` on a temporary directory that deletes files mid-run, ensuring error counting increments.

6. **Re-run Coverage & Update Targets**
   - After implementing steps 1–5, execute `cargo fmt`, `cargo clippy -- -D warnings`, `cargo test`, `cargo llvm-cov --summary-only`, and `cargo llvm-cov --json`.
   - Record the new coverage floor in this document and elevate the CI guard to at least regions =80% and lines =90% once stable.






