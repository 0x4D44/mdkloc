# Code Review Report – mdkloc

**Date**: 2025-10-24  
**Reviewer**: Codex (GPT-5)  
**Scope**: Entire repository (`src`, `tests`, `docs`, build metadata)

## Summary
- Identified one critical correctness bug and two important behaviour gaps that undermine the CLI’s reliability and accuracy.
- Highlighted structural issues (monolithic module, stale documentation/dependencies) that amplify onboarding and maintenance costs.
- Existing test infrastructure is strong but lacks coverage for the newly discovered regressions; targeted additions will keep future fixes safe.

## Critical Findings

### Critical: Explicit roots are skipped when name matches built-in ignores
- **Location**: `src/main.rs:2044-2049`
- **What happens**: `scan_directory_impl` aborts immediately whenever `path` matches the hard-coded ignore list (`target`, `node_modules`, etc.) or one of the user-provided `--ignore` tokens. Because this check runs before any depth comparison, it also fires when the ignored name is the *root* you asked mdkloc to analyse.
- **Impact**: Legitimate use cases like `mdkloc target` (audit build output) or `mdkloc node_modules` (dependency triage) yield an empty report and no warning, even though files exist. This is a correctness breakage that silently hides entire trees.
- **Reproduction** (from the repository root):
  1. `mkdir -p target && printf 'fn main() {}\n' > target/loc_fixture.rs`
  2. `cargo run -- target`
  3. The run succeeds but the detailed analysis table is empty even though `target/loc_fixture.rs` exists.
- **Fix approach**:
  - Only consult `is_ignored_dir` when `current_depth > 0`, *and* compare the canonical root before skipping.
  - For CLI-specified ignores, require `current_depth > 0` as well so authors can still audit a directory they listed in `--ignore`.
  - Add an integration test that runs against a directory literally named `target` to prevent regressions.

## Important Findings

### Important: Shell RC dotfiles are misclassified as generic code
- **Location**: `src/main.rs:273-305`, `src/main.rs:523-568`
- **Symptom**: `get_language_from_extension` recognises `.bashrc`, `.zshrc`, etc. as `Shell`, but `count_lines_with_stats` falls back to `count_generic_lines` for basename-only files. Comment lines (`# export PATH=…`) are therefore counted as code, distorting per-language and aggregate stats.
- **Fix approach**:
  - Mirror the dotfile lookup inside `count_lines_with_stats` and route to `count_shell_lines`.
  - Add a regression test (e.g., `test_count_lines_with_stats_shell_dotfile`) that asserts comment vs. code tallies for a `.bashrc` fixture.

### Important: Monolithic `src/main.rs` impedes maintainability
- **Location**: Entire `src/main.rs` (~7,000 lines)
- **Risk**: All functionality—CLI parsing, traversal, language counters, and hundreds of unit tests—lives in a single module. Any change triggers large recompiles, makes reviews unwieldy, and discourages incremental improvements.
- **Fix approach**:
  - Break the crate into logical modules (e.g., `cli.rs`, `scanner/`, `languages/`, `report.rs`, `metrics.rs`).
  - Move language-specific tests alongside their implementations or into dedicated integration suites to keep the root module slim.
  - Establish a staging plan so structural refactors land after the functional fixes above.

## Minor Findings

### Minor: Unused dependency
- **Location**: `Cargo.toml:8`
- **Details**: `unicode-normalization` is declared but never imported. It adds compile overhead and implies Unicode path handling that is not present.
- **Fix approach**: Remove the dependency (and lockfile entry) unless future work actually consumes it; update docs accordingly.

### Minor: README drift
- **Location**: `readme.md:1-55`
- **Issues**: Title still advertises `v2.0.0` despite `Cargo.toml` shipping `2.3.0`, and the feature list promises parallel execution the implementation does not provide.
- **Fix approach**: Align the version badge/heading with `Cargo.toml`, trim or defer the parallelism claim, and re-run through for any other stale promises (Unicode normalisation, etc.).

### Minor: Progress banner can emit infinities
- **Location**: `src/main.rs:189-196`
- **Details**: `files as f64 / elapsed` and `lines as f64 / elapsed` execute before `elapsed` is guaranteed to be > 0, so very fast runs can print `inf files/sec`.
- **Fix approach**: Reuse `safe_rate` (already handles the zero case) inside `print_progress`, or guard with a minimum elapsed threshold.

## Verification Gaps
- No automated test currently asserts that analysing a root named `target` succeeds.
- Shell dotfile detection lacks fixture coverage to prevent regression of comment counting.

## Positive Observations
- The test suite is impressively thorough: language parsers, failure-injection hooks, and CLI smoke tests cover most behaviours and will accelerate safe fixes.
- `LossyLineReader` and `PerformanceMetrics` encapsulations show careful handling of UTF-8 fallbacks and user-facing feedback.
- Failure sentinels (`METADATA_FAIL_TAG`, `READ_DIR_FAIL_TAG`, etc.) make it easy to exercise error paths without elaborate fixtures.

## Suggested Next Steps
1. Implement the root-ignore fix, plus regression coverage in `tests/cli_smoke.rs`.
2. Route shell dotfiles through `count_shell_lines` and add the missing unit test.
3. Clean up documentation and the unused dependency once behavioural fixes are in place.
4. Kick off a staged modularisation of `src/main.rs` to sustain future development velocity.
