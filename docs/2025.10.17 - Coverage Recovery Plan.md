# Coverage Recovery Plan (2025-10-17)

## Snapshot
- Latest `cargo llvm-cov --workspace --summary-only` (2025-10-17) reports regions 77.67%, lines 94.19%, functions 94.58% for `src/main.rs`.
- 664 regions and 206 lines remain uncovered; branch coverage is not yet tracked.
- Repository contains non-ASCII punctuation in source comments/tests and large coverage artifacts checked into `docs/` that need decisions before landing.

## Objectives
1. Lift region coverage to at least 85% and maintain line coverage >= 94% while keeping run time reasonable.
2. Resolve review follow-ups: normalize text assets to ASCII, document the coverage workflow, and right-size stored artifacts.
3. Establish automated enforcement (CI plus local checklist) so regressions are caught quickly.

## Key Issues Blocking Coverage Gains
- Comment parsers for Rust, PHP, Pascal, PowerShell, IPLAN, and C-style languages still miss mixed edge cases (block closures with trailing code, interleaved markers, docstring continuations).
- Directory traversal paths (`scan_directory_impl`, filespec filtering, error counting) lack scenarios that combine ignore patterns, max depth, and error propagation.
- Progress reporting uses injectable writers but throttling, disabled mode, and error accounting need stronger assertions.
- Non-ASCII punctuation in docstrings/tests (`src/main.rs:181`, `src/main.rs:1043`, `src/main.rs:3055-3059`) conflicts with repo guidelines.
- Bulky coverage dumps (`docs/2025.10.16 - coverage.json`, `docs/2025.10.16 - coverage.txt`) inflate the repository and risk going stale; README does not mention the new integration tests or coverage workflow.

## Action Plan
1. **Immediate Hygiene (Day 0-1)**
   - Replace smart punctuation with ASCII equivalents; update tests to assert on `char::REPLACEMENT_CHARACTER` explicitly.
   - Decide on retaining vs pruning large coverage outputs; if removing, add patterns to `.gitignore` and capture key stats in markdown instead.
   - Document smoke test and coverage commands in `readme.md` and link to `docs/` plan.

2. **Parser Coverage Sprint (Day 1-3)**
   - Build table-driven fixtures per language group exercising mixed block/line comment branches noted above.
   - Refine assertions so each uncovered branch (block reopen with inline code, nested comment, continuation escaping) is hit; track progress with per-function checklists.
   - Ensure new fixtures run through streaming reader to validate lossy UTF-8 handling in realistic files.

3. **Traversal and Progress Scenarios (Day 3-4)**
   - Extend directory scanning tests to cover: hitting `max_entries`, exceeding `max_depth`, mixed ignore patterns, and simulated IO failures (use temp dirs with removed permissions).
   - Add targeted tests for progress metrics: multiple throttled updates, disabled progress with non-empty workloads, and error counts reported in summary.

4. **Automation & Guardrails (Day 4-5)**
   - Re-run `cargo fmt`, `cargo clippy -- -D warnings`, full test suite, and `cargo llvm-cov --summary-only` to refresh metrics.
   - Capture before/after numbers in an updated `docs/coverage.md` (or append to dated logs).
   - Introduce CI job for `cargo llvm-cov --fail-under-lines 94 --fail-under-regions 85` once thresholds are met; note workflow in docs.

5. **Final Validation (Day 5)**
   - Confirm README instructions are accurate and all docs reference the latest coverage figures.
   - Squash or rebase commits, include sample CLI output in PR description, and highlight coverage delta.

## Success Criteria
- Region coverage >= 85% and lines >= 94% on 2025-10-17 baseline.
- No non-ASCII characters outside known binary fixtures.
- Large coverage artifacts either removed or justified with automation to refresh them.
- CI coverage gate in place and README reflects smoke test + coverage workflow.
