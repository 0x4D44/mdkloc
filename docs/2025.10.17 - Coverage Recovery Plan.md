# Coverage Recovery Plan (2025-10-17)

## Snapshot
- Baseline `cargo llvm-cov --workspace --summary-only` (2025-10-17, morning) showed regions 77.67%, lines 94.19%, functions 94.58% for `src/main.rs` with 664 regions and 206 lines uncovered.
- Follow-up run after parser test additions (2025-10-17, afternoon) reported regions 77.42%, lines 94.33%, functions 94.71%, leaving 691 regions and 205 lines uncovered.
- Latest run after directory/filespec coverage (2025-10-17, evening) reported regions 77.26%, lines 94.35%, functions 94.74%, with 704 regions and 207 lines still uncovered.
- Additional parser regression tests (2025-10-17, night) lifted metrics to regions 77.14%, lines 94.39%, functions 94.79%, leaving 715 regions and 207 lines uncovered.
- Hash/HCL coverage sweep (2025-10-17, late night) reported regions 77.08%, lines 94.44%, functions 94.84%, with 725 regions and 207 lines still uncovered.
- Expanded hash/HCL fixtures (2025-10-17, midnight) landed at regions 77.00%, lines 94.50%, functions 94.91%, leaving 739 regions and 207 lines uncovered.
- Parser additions (2025-10-17, late night) reported regions 77.31%, lines 94.47%, functions 94.81%, with 708 regions and 203 lines still uncovered.
- Directory-depth regression plus mixed parser fixtures (2025-10-17, night) now yield regions 77.16%, lines 94.44%, functions 94.84%, leaving 720 regions and 206 lines uncovered.
- CLI warning coverage (2025-10-17, late night) pushed metrics to regions 77.20%, lines 94.58%, functions 94.84%, with 719 regions and 201 lines uncovered.
- Additional hash/TOML/YAML fixtures (2025-10-17, night) initially landed at regions 77.11%, lines 94.62%, functions 94.88%, leaving 730 regions and 201 lines uncovered.
- Latest CLI regression tests (2025-10-17, late night) leave coverage at regions 76.99%, lines 94.66%, functions 94.93%, with 742 regions and 201 lines still uncovered.
- Auto-ignore regression (2025-10-17, late night) currently sits at regions 76.82%, lines 94.63%, functions 94.95%, leaving 755 regions and 204 lines uncovered.
- Repository previously contained non-ASCII punctuation in text assets and large coverage artifacts checked into `docs/`; these are now normalized/removed, with `.gitignore` updated to block future coverage dumps.

## Objectives
1. Lift region coverage to at least 85% and maintain line coverage >= 94% while keeping run time reasonable.
2. Resolve review follow-ups: normalize text assets to ASCII, document the coverage workflow, and right-size stored artifacts.
3. Establish automated enforcement (CI plus local checklist) so regressions are caught quickly.

## Key Issues Blocking Coverage Gains
- Comment parsers for Rust, PHP, Pascal, PowerShell, IPLAN, and C-style languages still miss mixed edge cases (block closures with trailing code, interleaved markers, docstring continuations).
- Directory traversal paths (`scan_directory_impl`, filespec filtering, error counting) lack scenarios that combine ignore patterns, max depth, and error propagation.
- Progress reporting uses injectable writers but throttling, disabled mode, and error accounting need stronger assertions.
- Non-ASCII punctuation in docstrings/tests (`src/main.rs:181`, `src/main.rs:1043`, `src/main.rs:3055-3059`) conflicted with repo guidelines; cleaned up on 2025-10-17.
- Bulky coverage dumps (`docs/2025.10.16 - coverage.json`, `docs/2025.10.16 - coverage.txt`) inflated the repository and risked going stale; removed on 2025-10-17 with `.gitignore` guard. README now documents the smoke/coverage workflow.

## Action Plan
1. **Immediate Hygiene (Day 0-1)**
   - Replace smart punctuation with ASCII equivalents; update tests to assert on `char::REPLACEMENT_CHARACTER` explicitly.
   - Decide on retaining vs pruning large coverage outputs; if removing, add patterns to `.gitignore` and capture key stats in markdown instead.
   - Document smoke test and coverage commands in `readme.md` and link to `docs/` plan.

2. **Parser Coverage Sprint (Day 1-3)**
   - Build table-driven fixtures per language group exercising mixed block/line comment branches noted above. (In progress: added C-style & JavaScript block-close + trailing comment cases, hash-only mixed fixtures, and HCL block-close coverage on 2025-10-17.)
   - Refine assertions so each uncovered branch (block reopen with inline code, nested comment, continuation escaping) is hit; track progress with per-function checklists.
   - Ensure new fixtures run through streaming reader to validate lossy UTF-8 handling in realistic files.

3. **Traversal and Progress Scenarios (Day 3-4)**
   - Extend directory scanning tests to cover: hitting `max_entries`, exceeding `max_depth`, mixed ignore patterns, and simulated IO failures (use temp dirs with removed permissions).
   - Add targeted tests for progress metrics: multiple throttled updates, disabled progress with non-empty workloads, and error counts reported in summary.

4. **Automation & Guardrails (Day 4-5)**
   - Re-run `cargo fmt`, `cargo clippy -- -D warnings`, full test suite, and `cargo llvm-cov --summary-only` to refresh metrics.
   - Capture before/after numbers in an updated `docs/coverage.md` (or append to dated logs).
   - Introduce CI job for `cargo llvm-cov --fail-under-lines 94 --fail-under-regions 85` once thresholds are met; note workflow in docs.

5. **Final Validation (Day 5)**
   - Confirm README instructions are accurate and all docs reference the latest coverage figures.
   - Squash or rebase commits, include sample CLI output in PR description, and highlight coverage delta.

## Success Criteria
- Region coverage >= 85% and lines >= 94% on 2025-10-17 baseline.
- No non-ASCII characters outside known binary fixtures.
- Large coverage artifacts either removed or justified with automation to refresh them.
- CI coverage gate in place and README reflects smoke test + coverage workflow.
