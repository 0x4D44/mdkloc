# Audit Remediation Roadmap – mdkloc

**Date**: 2025-10-24  
**Source**: `docs/2025.10.24 - CR - Full repository audit.md`  
**Goal**: Resolve critical/important defects, shore up documentation, and lay groundwork for maintainability improvements.

---

## Stage 0 – Mobilisation & Baseline
- Confirm ownership, reviewers, and target branch strategy.
- Capture current CLI behaviour on fixtures (`target/`, shell RC files) for regression comparisons.
- Ensure local toolchain (Rust stable toolchain, `cargo fmt`, `cargo clippy`) is ready; cache crates.io dependencies if sandboxed.

## Stage 1 – Fix root-ignore correctness bug (Critical)
- Update `scan_directory_impl` so built-in ignores (`target`, `node_modules`, etc.) only apply when `current_depth > 0` and do not skip the canonical root.
- Apply the same depth guard to user-specified `--ignore` values.
- Add integration coverage in `tests/cli_smoke.rs` that runs `mdkloc` against a root named `target` and verifies language totals appear.
- Verify existing failure-injection tests still pass.

## Stage 2 – Restore shell dotfile accuracy (Important)
- Extend `count_lines_with_stats` to route recognised shell dotfiles (e.g., `.bashrc`, `.zshrc`, `.profile`) to `count_shell_lines`.
- Add a unit test (e.g., `test_count_lines_with_stats_shell_dotfile`) with comment-heavy fixtures to lock behaviour.
- Re-run relevant CLI smoke test to ensure per-language totals now reflect comments vs. code.

## Stage 3 – Harden progress reporting (Minor)
- Reuse `safe_rate` inside `PerformanceMetrics::print_progress` (or guard against sub-second elapsed time) to prevent `inf` rates.
- Add a fast-path unit test to exercise the zero-duration case.

## Stage 4 – Documentation & Dependency alignment (Minor)
- Update `readme.md` to reflect the actual crate version (`2.3.0`) and remove unsupported claims (parallel processing, Unicode normalization).
- Drop `unicode-normalization` from `Cargo.toml`/`Cargo.lock` unless reintroduced with implementation; adjust docs accordingly.
- Run `cargo fmt`, `cargo clippy -- -D warnings`, and `cargo check` after documentation/dependency edits.

## Stage 5 – Modularisation groundwork (Important, strategic)
- Sketch module boundaries (`cli`, `scanner`, `languages`, `report`, `metrics`).
- Identify high-risk dependencies between sections of `src/main.rs` and draft a phased extraction plan.
- Open follow-up issue(s) to track the refactor once functional fixes are merged.

## Stage 6 – Validation & Release Prep
- Execute full regression suite (`cargo test`, targeted CLI runs) after each stage.
- Record before/after CLI output for release notes or changelog.
- Prepare release communication summarising bug fixes and documentation updates; coordinate tag once tests pass.

---

**Tracking**: Update the project journal (`journal/2025.10.24 - JRN - Repository code review.md`) as each stage progresses. Align this roadmap with `docs/2025.10.24 - REQS - Report remediation plan.md` to avoid divergence.
