# Remediation Plan – mdkloc

**Date**: 2025-10-25  
**Source**: Findings from `docs/2025.10.25 - CR - Repository review.md`

## Stage 1 – Restore Core Correctness (Priority: Critical, ETA: 1–2 days)
1. **Root ignore bypass fix**  
   - Update `scan_directory_impl` so the auto-ignore list and `--ignore` tokens apply only when `current_depth > 0` (or honor explicit include overrides).  
   - Add an integration test covering `mdkloc <path>/target` to ensure non-empty output.  
   - Acceptance: Running the previous repro command reports Rust stats; existing ignore behavior for nested directories remains intact.
2. **Shell dotfile routing**  
   - Extend `count_lines_with_stats` to recognize the shell dotfiles already handled in `get_language_from_extension` and delegate to `count_shell_lines`.  
   - Add a unit test (`test_count_lines_with_stats_shell_dotfile`) verifying comment vs. code counts for `.bashrc`.  
   - Acceptance: `cargo run -- tmp-review/dotfiles --non-recursive --verbose` reports correct comment totals.
3. **`--max-entries` enforcement**  
   - Increment and check the entry counter for every directory entry (or track a second counter for directories) before processing.  
   - Introduce a CLI smoke test that constructs a directory-heavy fixture and asserts the run errors once the limit is exceeded.  
   - Acceptance: `cargo run -- tmp-review/fanout --max-entries 1` fails with the guard before recursing all directories.

## Stage 2 – Traversal Efficiency & Coverage (Priority: High, ETA: 2–3 days)
1. **Filespec-aware traversal**  
   - Investigate heuristics for skipping directories when `--filespec` indicates no possible matches (suffix filters, opt-in allowlists).  
   - Document the chosen behavior and add integration coverage proving traversal shrinks for filtered runs.  
   - Acceptance: Profiling on a tree with many non-matching directories shows a measurable reduction in visited paths.
2. **Regression suite expansion**  
   - Add tests for: analyzing user-ignored root names, shell dotfiles, `--max-entries` limits, and filespec traversal behavior.  
   - Ensure failures produce descriptive errors/warnings and capture outputs for documentation.

## Stage 3 – Documentation & Dependency Alignment (Priority: Medium, ETA: 1 day)
1. **README realignment**  
   - Update version references to `2.3.0` (or the next release), remove claims about parallelism/Unicode normalization unless implemented, and describe the clarified behavior for `--filespec`/`--max-entries`.  
   - Include the new regression commands in a troubleshooting section.
2. **Dependency cleanup**  
   - Drop `unicode-normalization` from `Cargo.toml`/`Cargo.lock` unless path normalization work is introduced.  
   - Note the change in the changelog/readme so users know the feature isn’t present.

## Stage 4 – Structural Refactor (Priority: Medium, ETA: multi-iteration)
1. **Module extraction**  
   - Split `src/main.rs` into modules (`cli`, `scanner`, `languages`, `report`, `metrics`).  
   - Move unit tests beside their respective modules to keep the entry point slim.  
   - Acceptance: `main.rs` becomes a coordinator (~200–300 LOC) and incremental builds focus on touched modules.
2. **Follow-up automation**  
   - Add linting/clippy configs to enforce module boundaries and prevent regression to a single-file design.

## Stage 5 – Monitoring & Follow-up (Priority: Continuous)
1. **Validation checklist**  
   - Before release, rerun the validation commands listed in the review (target root, shell dotfile, fan-out limit).  
   - Automate them via CI where feasible.  
2. **Issue tracking**  
   - File GitHub issues (or internal tickets) for each stage, linking to the review evidence to keep progress visible.
