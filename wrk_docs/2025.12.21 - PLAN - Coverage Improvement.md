# Coverage Improvement Plan
**Date:** 2025.12.21
**Target:** 98% Line Coverage

## Phase 1: Symlink Support (High Impact)
The `handle_symlink` function is currently 0% covered. This is the single largest gap.
- [ ] **Task 1:** Add `test_handle_symlink_dir` and `test_handle_symlink_file` to `src/tests_included.rs`.
    - These tests must run on Unix-like systems (Linux/macOS) where `std::os::unix::fs::symlink` is available. For Windows, we might need `std::os::windows::fs::symlink_file` / `symlink_dir` and administrator privileges, or we conditionally skip them.
    - *Note:* The existing `test_symlinked_file_counted_once` is `#[cfg(unix)]`. We should verify if `handle_symlink` is being called at all on Windows. If `mdkloc` is cross-platform, we should ensure `handle_symlink` is tested on the running platform or mocked.

## Phase 2: Rust Parser Robustness
The `BraceScanState` and `RustRoleTracker` have missing branches regarding complex string escaping and raw strings.
- [ ] **Task 2:** Add `test_rust_escaped_strings` to verify `\` handling in normal strings.
- [ ] **Task 3:** Add `test_rust_raw_string_edge_cases` to cover:
    - `r#"` followed by non-matching hashes.
    - `"` inside raw strings that doesn't close them.

## Phase 3: Language Parser Edge Cases
Several language counters have minor logic gaps.
- [ ] **Task 4:** **JavaScript:** Add `test_javascript_comment_transitions` to cover:
    - Closing `/* ... */` and `<!-- ... -->` on the same line and verifying state reset.
    - Complex boolean conditions in line 1431.
- [ ] **Task 5:** **PowerShell:** Add `test_powershell_complex_comments` for edge cases in `find_powershell_line_comment`.
- [ ] **Task 6:** **Pascal:** Add `test_pascal_nested_comment_balance` to exercise the exact 0-level checks.

## Phase 4: Path & Role Inference
- [ ] **Task 7:** Add `test_infer_role_complex_paths` to iterate through path components that *don't* match "tests" to exercise the negative branches.

## Phase 5: Error Handling
- [ ] **Task 8:** Add `test_count_lines_read_error` using a custom `Read` implementation that fails mid-stream to trigger the `?` operator coverage in `count_rust_lines` (and others).

## Execution Strategy
1.  Implement Phase 1.
2.  Run `cargo llvm-cov` to verify increase.
3.  Implement Phase 2 & 3.
4.  Run `cargo llvm-cov`.
5.  Implement Phase 4 & 5.
6.  Final Verification.
