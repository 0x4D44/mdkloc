# Coverage Assessment – mdkloc
Date: 2025-11-18  
Author: Codex

## Methodology
- Ran `cargo llvm-cov --summary-only --ignore-filename-regex 'src/tests_included.rs$'` to focus on shipping code (`src/main.rs`).
- Toolchain: nightly LLVM-based instrumentation via `cargo-llvm-cov` (same configuration documented in `readme.md`).
- Examined missing-line output from `--show-missing-lines` to pinpoint specific gaps.

## Summary Metrics
| Metric | Value |
| --- | --- |
| Lines covered | 2,319 / 2,391 (96.99%) |
| Regions covered | 3,496 / 3,698 (94.54%) |
| Functions executed | 157 / 163 (96.32%) |

The shipping binary currently sits below the 98% line-coverage target referenced in the README’s enforcement command. 72 executable lines remain untested.

## Key Gap Areas
1. **LanguageEntry bookkeeping (`src/main.rs:220-260`)**  
   - `record_roles`’ early return (line 222) never executes, so we have no regression test ensuring the function ignores empty inputs.  
   - `role_summary` is only used when the `--role-breakdown` flag is active, meaning the new code path lacks direct unit coverage.

2. **Role inference heuristics (`src/main.rs:274-305`)**  
   - Lines 285, 287, and 301 (components of `infer_role_from_path`) remain unexecuted in tests, so nested `tests/` directories and special filename suffixes are unguarded.

3. **Rust role tracker + string scanner (`src/main.rs:306-390`)**  
   - Entire chunks within `BraceScanState::scan_line` (lines 333-390) never execute in tests. These cover raw string literals (`r#"…"#`), ordinary `'` char literals, and comment termination logic—precisely the machinery that keeps brace balancing accurate when test attributes appear near literals.

4. **Pending-scope management in `RustRoleTracker` (`src/main.rs:432-489`)**  
   - Lines 436-438 and 485-486 (clearing pending scope for `#[test] fn foo();`) lack coverage, as do the `#[cfg(not(test))]` guard paths, making it easy to regress attribute parsing.

5. **Rust role-aware counter (`src/main.rs:1137-1185`)**  
   - The new “empty file under `tests/`” fallback (lines 1139-1145) is untested.  
   - Block-comment handling (lines 1157-1166) only partially executes: we don’t cover the branch where a comment line ends on the same line as closing `*/` (rest empty) versus trailing code.

6. **Verbose multi-role logging (`src/main.rs:2558-2579`)**  
   - Line 2570 (printing per-role labels) doesn’t execute because our verbose test uses a pure-mainline file; none of the tests confirm the multi-role formatting.

7. **Symlink branch in `scan_directory_impl` (`src/main.rs:2718-2740`)**  
   - Although we have tests covering symlinked files, coverage shows the `file_type.is_symlink()` branch is still unhit, suggesting the existing test bypasses this code path.

8. **Role breakdown reporting (`src/main.rs:2920-2993`)**  
   - The “no role data” fallback (lines 2990-2993) never executes; we only test the populated tables.

9. **`handle_symlink` fallback (`src/main.rs:520-529`)**  
   - The branch for non-file/dir symlink targets is untested; while difficult to exercise, its presence keeps coverage below target.

## Impact
- The uncovered branches cluster around the brand-new role framework, meaning regressions could silently misclassify tests, double-count files, or panic on exotic strings.  
- Lack of coverage on the CLI reporting additions makes it easy to break `--role-breakdown` output or forget to emit the “no data” notice.  
- Missing tests for the symlink path and attribute parsing leave filesystem and parser edge cases unguarded.

## Recommendations
1. **Unit-test the role book-keeping helpers** (LanguageEntry) to guarantee empty inputs are ignored and role summaries reflect multiple buckets.
2. **Add targeted tests for `infer_role_from_path`** covering `tests/` in nested paths plus suffix-based detection (`*.spec.ts`).
3. **Exercise `BraceScanState` / `detect_rust_line_roles`** with raw strings, char literals, and raw string hashes to prove braces remain balanced.
4. **Cover pending-scope handling** by feeding `#[test] fn foo();` sequences and `#[cfg(not(test))]` attributes into the tracker; assert they don’t enable test mode.
5. **Add regression tests for the role-aware Rust counter**: empty test files, block comments terminating with and without trailing code, etc.
6. **Expand verbose-mode integration tests** so multi-role files emit per-role lines even without the CLI flag; capture output to validate formatting.
7. **Create a temporary symlink inside `scan_directory_impl`** to ensure the symlink branch executes during coverage runs (even if the link resolves to a file).  
8. **Add a regression test for the role breakdown “no data” path** to lock in the message users see when a role has zero stats.
9. **If exercising `handle_symlink`’s “neither file nor dir” branch remains impractical, consider collapsing it into the `is_file` path or explicitly logging it so that the code becomes reachable.**

These steps will push the shipping binary beyond the 98% line-coverage target while fortifying the newest role-detection features.
