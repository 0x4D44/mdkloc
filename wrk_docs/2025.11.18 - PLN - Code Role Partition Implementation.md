# Code Role Partition – Implementation Plan
*Date:* 2025-11-18  
*Author:* Codex (mdkloc)  
*Design Reference:* `wrk_docs/2025.11.18 - HLD - Code Role Partitioning.md`

## 1. Objectives
- Deliver the role-aware counting framework described in the HLD while keeping legacy output stable by default.
- Land functionality incrementally (data model → counting → reporting) so regressions are easy to isolate.
- Ensure every stage has automated test coverage and executable acceptance criteria.

## 2. Stage Breakdown

### Stage 0 – Preconditions & Baseline
- **Goals:** Verify repo is clean, capture current CLI golden outputs, and document how to spot regressions.
- **Tasks:**
  - Run `cargo fmt`, `cargo clippy -- -D warnings`, and `cargo test` to confirm green baseline.
  - Snapshot relevant CLI integration outputs (or ensure fixtures accurately reflect v2.0.0 behavior).
  - Create a short checklist in `journal/` noting commands + observed runtime for later comparison.
- **Exit Criteria:** All commands pass without modifications; no pending git diff.

### Stage 1 – Data Model & Aggregation Refactor
- **Goals:** Introduce `CodeRole`, `RoleStats`, `LanguageEntry`, and update `DirectoryStats` + helpers while keeping external behavior unchanged.
- **Tasks:**
  1. Add new enums/structs plus helpers (`RoleStats::merge`, `LanguageEntry::flatten`).
  2. Refactor `DirectoryStats.language_stats` to store `LanguageEntry` instead of `(file_count, LanguageStats)`.
  3. Update `process_file`, `merge_directory_stats`, and `build_analysis_report` to work with flattened totals for default output.
  4. Adjust unit tests touching these structures (`tests_included.rs`).
- **Testing:** Re-run `cargo test` + affected integration tests (`cli_*`). Expect no output diffs.
- **Exit Criteria:** Identical CLI output vs. baseline when run without new flags; code compiles with clippy clean.

### Stage 2 – Role-Aware Counting Pipeline
- **Goals:** Replace `count_lines_with_stats` plumbing with `count_lines_with_roles` and propagate `FileRoleHint` signals, but still route all stats to `Mainline`.
- **Tasks:**
  1. Implement `FileRoleHint` enum + `infer_role_from_path` (Rust integration test directories handled now; other languages return `Unknown`).
  2. Introduce `RoleSplit` and refactor counting call sites to consume the new structure.
  3. Provide a default adapter for existing language functions so they yield `Mainline` stats; zero functional change expected.
- **Testing:** Unit tests for `infer_role_from_path`. Re-run entire suite to ensure parity.
- **Exit Criteria:** Build/test pass; verbose runs show new plumbing only when `--verbose` flag is used (optional logs behind verbose gate).

### Stage 3 – Rust Role Detection
- **Goals:** Populate `Test` buckets for Rust sources via intra-file detection and path hints for `tests/**/*.rs`.
- **Tasks:**
  1. Implement role-aware Rust parser (state machine for `#[cfg(test)]`, `mod tests`, `#[test]`).
  2. Wire `infer_role_from_path` so files under `tests/` default to `TestFile`, but allow parser overrides.
  3. Extend `tests_included.rs` with fixtures containing inline test modules and verify counts split across roles.
  4. Add regression tests for Rust integration tests directory (ensuring blank/comment lines in tests stay inside the `Test` role).
- **Testing:** Run targeted unit tests plus `cargo test --test cli_totals.rs` against a fixture containing Rust tests; confirm default output remains unchanged (because we still flatten roles for reporting at this stage).
- **Exit Criteria:** Internals correctly distinguish roles (verified through new assertions) without changing CLI tables.

### Stage 4 – CLI Surface & Documentation
- **Goals:** Expose role metrics behind a new `--role-breakdown` flag and document behavior.
- **Tasks:**
  1. Extend `Args` with boolean flag; update `build_analysis_report` to render additional sections when enabled.
  2. Update `readme.md` with description + sample output; mention performance/limitations.
  3. Add at least one integration test invoking the flag and asserting the new output structure.
  4. Ensure default (flag-off) scenario still matches existing fixtures to prevent churn.
- **Testing:** Full `cargo test`; targeted CLI test verifying new tables; manual smoke run `cargo run -- . --role-breakdown` for sanity.
- **Exit Criteria:** CLI outputs three sections (legacy table + per-role tables) when flag is set; documentation synchronized.

### Stage 5 – Polishing & Follow-Ups
- **Goals:** Address remaining risks/cleanup and prepare for future languages.
- **Tasks:**
  - Add metrics/logging for files classified as tests (visible only in verbose mode and/or new summary counters).
  - Evaluate HashMap vs. fixed array for `per_role` storage; optimize if needed.
  - Document TODOs for Go/Python/JS heuristics and doctest handling.
- **Exit Criteria:** Tracking issues filed or TODO comments added; repo ready for expansion workstreams.

## 3. Cross-Cutting Concerns
- **Performance:** Monitor compile-time warnings and runtime overhead each stage; record any regressions in `journal/`.
- **Versioning:** Consider bumping minor version once Stage 4 lands; update `Cargo.toml` and changelog accordingly.
- **Communication:** Provide interim updates after Stage 1 (structural change) and Stage 3 (Rust support) since these carry regression risk.

## 4. Timeline & Ownership (tentative)
| Stage | Est. Effort | Target Date | Notes |
|-------|-------------|-------------|-------|
| 0 | 0.5 day | 2025-11-19 | Baseline health check |
| 1 | 1.5 days | 2025-11-21 | Structural refactor |
| 2 | 1.0 day | 2025-11-24 | New counting adapter |
| 3 | 2.0 days | 2025-11-27 | Rust parser complexity |
| 4 | 1.0 day | 2025-12-01 | CLI + docs + tests |
| 5 | 0.5 day | 2025-12-02 | Polish + follow-ups |

(Adjust as testing feedback arrives.)

## 5. Success Metrics
- Default CLI output identical to v2.0.0 across smoke fixtures.
- New `--role-breakdown` output verified in integration tests.
- Rust projects show reduced “code” totals when tests are excluded, demonstrating practical differentiation.
- No performance regression greater than 5% in measured scans of this repo.
