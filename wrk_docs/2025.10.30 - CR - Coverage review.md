# Coverage Review (2025-10-30)

## Executive Summary
- Tooling: `cargo llvm-cov --summary-only` executed on 2025-10-30.
- Crate: single binary `mdkloc` with tests in `src/main.rs` and `tests/cli_smoke.rs`.
- Results (workspace total):
  - Regions: 85.09%
  - Functions: 90.33%
  - Lines: 91.51%

The suite achieves high line and function coverage. Region coverage remains below 90% due to complex branch-heavy parsers and numerous mixed-comment scenarios across languages.

## How Coverage Was Measured
Commands used (ran locally in the repo root):

1. `cargo test -- --nocapture`
2. `cargo llvm-cov --summary-only`
3. `cargo llvm-cov --json --output-path target/coverage.json` (for detailed inspection)

All tests pass (269 unit tests, 14 integration tests). Coverage output for the single source file is summarized below.

```
Filename                                                        Regions    Missed Regions     Cover   Functions  Missed Functions  Executed       Lines      Missed Lines     Cover
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
src/main.rs                                                       12087              1802    85.09%         424                41    90.33%        7410               629    91.51%
TOTAL                                                             12087              1802    85.09%         424                41    90.33%        7410               629    91.51%
```

## Strengths
- Broad unit coverage of language counters (Rust, C-style family, HCL/Terraform, INI/CFG, Dockerfile, XML/HTML, TOML, YAML, PowerShell, Pascal, Algol, COBOL, Fortran, Assembly, DCL, IPLAN, TCL, Mustache, Velocity, ReStructuredText).
- Integration tests exercise CLI surfaces end-to-end: filespec filtering, ignore lists, non-recursive scans, depth limiting, symlink handling, error/warning surfacing, and performance summary.
- Progress reporting paths (`PerformanceMetrics`) are invoked and validated through tests that inject a custom writer.
- Directory traversal failure modes are thoroughly tested (simulated metadata/read_dir/file_type/entry iteration errors), and metrics aggregation is validated against expected totals.

## Gaps and Opportunities
- Region coverage: complex, multi-branch comment lexers (notably C-style, HCL, and language-specific corner cases) leave some mixed-sequence paths unvisited (e.g., block-close followed immediately by hash/line comment, interleaved pairs across multiple segments on one line).
- Mapping helpers: additional dotfile cases (e.g., `.kshrc`, `.cshrc`) were not previously asserted; these have now been added.
- Diagnostic variants: certain error strings and path-dependent messages were brittle in older tests; updated to assert on stable substrings to avoid spurious failures that block coverage runs.

## Changes Made During This Review
- Fixed a brittle assertion in `tests/cli_smoke.rs::cli_errors_when_max_entries_zero` to match the current error wording ("Maximum entry limit …").
- Added dotfile assertions for `.kshrc` and `.cshrc` in `test_dotfile_language_detection`.
- Re-ran coverage; current line coverage is 91.51% (≥ 90% target), functions 90.33%, regions 85.09%.

## Recommendations
- Treat ≥90% line coverage as the first acceptance bar in CI; add a `cargo llvm-cov --fail-under-lines 90` guard once stable.
- Incrementally raise region coverage by adding narrowly scoped, table-driven tests for seldom-hit mixed-comment branches. Prioritize C-style and HCL combinatorics where small fixtures can exercise multiple transitions per line.
- Keep assertions resilient to minor wording changes (assert on key substrings, not entire messages), especially for failure-path tests.

