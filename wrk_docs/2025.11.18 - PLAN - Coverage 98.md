# Coverage Improvement Plan – Target 98%
Date: 2025-11-18  
Author: Codex

## Stage 1 – Role Infrastructure Unit Tests
**Goal:** Cover low-level helpers so `LanguageEntry`, `infer_role_from_path`, and `attribute_indicates_test` logic cannot regress.  
**Actions:**
1. Add unit tests for `LanguageEntry::record_roles` (empty input) and `role_summary` to confirm total/file counts behave correctly.
2. Extend `infer_role_from_path` tests with nested `tests/` directories and filename suffix patterns (`*.spec.ts`).
3. Add tests for `attribute_indicates_test` and pending-scope clearing (include `#[cfg(not(test))]` and `#[test] fn foo();`).
**Exit Criteria:** `cargo test` passes and coverage shows the gap at lines 222/285/287/301/459/485-486 closed.

## Stage 2 – Rust Role Tracker & Counter Edge Cases
**Goal:** Exercise `BraceScanState` and `count_rust_lines_role_aware` branches (raw strings, block comments, empty test files).  
**Actions:**
1. Add targeted tests for `detect_rust_line_roles` that include raw strings (`r#"…"#`), char literals, and nested braces to cover lines 333-390.
2. Create new fixtures for multi-line block comments with and without trailing code to hit lines 1157-1166.
3. Add tests ensuring empty files under `tests/` default to the Test role, covering lines 1139-1145.
**Exit Criteria:** Coverage for the Rust parser state machine exceeds 98% of its lines.

## Stage 3 – Reporting & Integration Coverage
**Goal:** Cover CLI/UI additions and filesystem branches.  
**Actions:**
1. Extend `test_process_file_verbose_prints_stats` (or add a new test) to include files with both mainline and test roles so verbose output prints `Role:` lines (line 2570).
2. Add an integration test that runs `build_analysis_report` with `--role-breakdown` but no role data, asserting the "No … data collected" message (lines 2990-2993).
3. Write a regression test that invokes `scan_directory_impl` on a directory containing a symlink to ensure the `file_type.is_symlink()` branch executes (line 2740).
4. If practical, add a targeted test (possibly via mock metadata) to cover the fallback branch in `handle_symlink`; otherwise, justify and refactor to remove the unreachable code.
**Exit Criteria:** Coverage for CLI/reporting sections reaches 98%, and total line coverage ≥ 98%.

## Stage 4 – Audit & Tune
**Goal:** Re-run `cargo llvm-cov --summary-only --ignore-filename-regex 'src/tests_included.rs$'` and ensure line coverage ≥ 98%.  
**Actions:**
1. Execute `cargo fmt`, `cargo clippy -- -D warnings`, and `cargo test` to keep the repo clean.
2. Capture the new coverage summary and update the journal with before/after deltas.
3. If coverage is still <98%, identify any remaining uncovered clusters and add micro-tests as needed.
**Exit Criteria:** Verified >=98% line coverage for `src/main.rs` under the documented command.
