# Multistage Coverage Improvement Plan (2025-10-30)

## Target and Current Baseline
- Current (2025-10-30): Regions 85.09%, Functions 90.33%, Lines 91.51%.
- Target: Maintain ≥90% Lines (achieved), and lift Regions toward ≥88% short-term.

## Strategy
- Preserve the lightweight, single-crate design; add tests only.
- Prefer minimal fixtures that hit multiple branches per line (block+line+hash combos) to efficiently increase region coverage.

## Stages
1. Close Test Fragility (Done)
   - Normalize brittle assertions on error text in CLI tests.
   - Ensure tests don’t block coverage runs due to phrasing drift.
2. Mapping/Dispatch Gaps (Done)
   - Add dotfile coverage for `.kshrc` and `.cshrc` to harden Shell detection.
3. Region Hotspots (Next)
   - Add table-driven tests for mixed-comment paths in C-style and HCL lexers:
     - Sequences: code /*block*/ code //line, code /*block*/ #hash, /*block*/ then trailing code then //line.
     - Multiple pairs on one line, and reopen-after-close patterns.
4. CLI Edge Surfaces (Next)
   - Add an integration case verifying `--max-entries` boundary behavior with nested directories (ensures early-exit and message remain covered).
5. CI Guardrail (Later)
   - Add a CI step: `cargo llvm-cov --workspace --fail-under-lines 90`.

## Verification
- After each stage: `cargo fmt`, `cargo test`, `cargo llvm-cov --summary-only`.
- Track deltas in `wrk_docs/` and keep JSON (`target/coverage.json`) for drill-down when needed.

## Notes
- No dependency changes required; `cargo-llvm-cov` is already present in the environment.
- Avoid widening public interfaces; unit tests live in `src/main.rs` under `#[cfg(test)]`, integration tests in `tests/`.

