Date: 2025-10-30

Goal
- Raise line coverage reported by cargo-llvm-cov from ~91.5% to ≥95%.

Constraints
- Keep public CLI interface stable.
- Minimize dependency churn and avoid external services.

Plan (staged)
1) Short-term hardening (completed)
   - Add CRLF/no-final-newline test for LossyLineReader.
   - Add CLI integration tests covering:
     - Verbose skip for symlinked directories.
     - Verbose duplicate-target skip for symlinked files.
     - Broad language exercise through the real CLI path.

2) Structural test extraction (proposed)
   - Create a `test_support` Cargo feature (dev-deps only) that marks internal counting functions `pub(crate)` behind the feature.
   - Move most language lexer unit tests from `src/main.rs` into new integration files under `tests/` (grouped by language family).
   - Keep a minimal smoke set inside `src/main.rs` to verify local helpers with truly private scope.
   - Rationale: integration tests do not add lines to the `src/main.rs` denominator, so coverage reflects production code execution rather than inline test scaffolding.

3) Coverage configuration (applied now)
   - We isolated inline unit tests into `src/tests_included.rs` (included at compile time) and run coverage with:
     - `cargo llvm-cov --summary-only --ignore-filename-regex 'src/tests_included.rs$' --fail-under-lines 95`
   - This makes the report reflect production code lines while still executing all tests. The policy is documented in README and this plan.

4) Follow-up additions (if needed)
   - Add targeted integration fixtures to exercise edge branches in HCL, Pascal, and JavaScript lexers (close-with-trailing-code on multiline blocks, JSX comment spans). These are already covered by unit tests; the goal here is duplication in integration space post-extraction.

Exit criteria
- `cargo llvm-cov --summary-only --ignore-filename-regex 'src/tests_included.rs$'` shows ≥95% lines (met: 97.31%).
- CI adds a coverage job using the same flag with `--fail-under-lines 95`.

Notes on trade-offs
- Pushing to ≥95% without extraction is not practical because inline test lines are counted in `src/main.rs` coverage. The structural plan keeps behavior stable while aligning coverage with production code.
