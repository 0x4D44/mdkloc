# Code Coverage Assessment
**Date:** 2025.12.21

## Overview
This report provides a detailed assessment of the code coverage for the `mdkloc` repository. The goal is to identify areas with low coverage and devise a plan to improve the overall coverage to at least 98%.

## Current Status
Based on the latest `llvm-cov` report:
- **Total Coverage:** ~92.36% lines (86.86% regions).
- **`src/main.rs`:** ~97.40% line coverage.
- **`src/tests_included.rs`:** ~90.05% line coverage.

## Critical Misses
The following areas in `src/main.rs` have been identified as having significant missing coverage:

1.  **`handle_symlink` (Lines 522-546):**
    - **Status:** Completely uncovered (0 hits).
    - **Impact:** Logic for handling symbolic links, including metadata resolution and recursion, is untested.
    - **Action:** Add a test case that creates a symlink pointing to a directory and another pointing to a file, then scans them.

2.  **`BraceScanState` Edge Cases:**
    - **Escaped Characters in Strings (Line 337-339):** Handling of `\` inside normal strings is not fully exercised.
    - **Raw String Termination (Lines 354-355, 392-394):** Logic for matching the closing sequence of raw strings (e.g., `r#"..."#`) has uncovered branches, specifically when the hash count doesn't match or when the closing quote is found but not followed by the correct number of hashes.

3.  **`infer_role_from_path` (Lines 290-292, 306):**
    - **Path Component Iteration:** The loop that checks for "tests" directories has branches that are not fully taken (e.g., when a component is not "tests").
    - **Filename Heuristics:** The fallback `FileRoleHint::Unknown` path is hit, but specific non-matching filename scenarios might need explicit verification to ensure they don't falsely trigger.

4.  **`find_powershell_line_comment` (Lines 598-599):**
    - **Status:** Some branches inside the loop are uncovered.
    - **Action:** Add test cases with complex PowerShell comments, including those inside strings or near block comments.

5.  **Error Propagation in Line Counters:**
    - **`count_rust_lines` (Line 1101):** The `?` operator on `line_result` is not triggered (0 hits).
    - **Action:** Add a test with a file that contains invalid UTF-8 that `LossyLineReader` handles, or simulate a read error if possible (though `LossyLineReader` usually handles UTF-8 errors by replacing characters). *Correction:* `LossyLineReader` returns `io::Result<String>`, so we need to mock a reader that fails *after* the first line to trigger this.

6.  **`count_javascript_lines` (Lines 1406-1407, 1418-1419):**
    - **Status:** Logic for resetting `in_block_comment` and `in_jsx_comment` flags has uncovered branches.
    - **Action:** Ensure tests cover the exact transition from inside a comment to outside on the same line.

## Plan Strategy
The improvement plan will focus on "Mainline" code (`src/main.rs`). We will iteratively address the items above, starting with the completely uncovered `handle_symlink` function.

## Next Steps
1.  Create `wrk_docs/2025.12.21 - PLAN - Coverage Improvement.md`.
2.  Implement `test_handle_symlink` to cover the symlink logic.
3.  Implement specific edge-case tests for `BraceScanState`.
4.  Add tests for `infer_role_from_path` with diverse path structures.
5.  Refine language-specific counters (PowerShell, JS, Pascal) with tricky input files.
